{% extends 'base.html' %}

{% block title %}ScanWiseAI - X-ray ile HastalÄ±k Tespiti{% endblock %}

{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div class="p-6">
            <!-- KÄ±sa AÃ§Ä±klama ve Bilgilendirme -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">X-ray ile HastalÄ±k Tespiti</h2>
                <p class="text-gray-700 mb-2">Bu modÃ¼l, yÃ¼klediÄŸiniz X-ray gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ analiz ederek aÅŸaÄŸÄ±daki hastalÄ±klarÄ±n tespitine yardÄ±mcÄ± olur:</p>
                <ul class="list-disc list-inside text-gray-700 mb-2">
                    <li>SaÄŸlÄ±klÄ±</li>
                    <li>Konjenital Anomali</li>
                    <li>KOAH</li>
                    <li>Mediastinal Kitle</li>
                    <li>Plevral EfÃ¼zyon</li>
                    <li>AkciÄŸer Ä°ltihabÄ±</li>
                    <li>AkciÄŸer SÃ¶nmesi (Pneumotorax)</li>
                    <li>TÃ¼berkÃ¼loz</li>
                    <li>AkciÄŸer TÃ¼mÃ¶rÃ¼</li>
                </ul>
                <p class="text-gray-600">Yapay zeka destekli analiz ile erken teÅŸhis ve tedavi ÅŸansÄ±nÄ±zÄ± artÄ±rÄ±n.</p>
            </div>

            <!-- Ã–rnek Dosya veya Demo -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                <span class="text-blue-700 font-medium">Sistemi denemek iÃ§in Ã¶rnek X-ray gÃ¶rÃ¼ntÃ¼lerini indirebilirsiniz.</span>
                <a href="/static/demo/ornek_xray.zip" download class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-300">Ã–rnek Dosya Ä°ndir</a>
            </div>

            <!-- Tahmin Formu -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <form action="" method="post" enctype="multipart/form-data" class="space-y-4" id="predictionForm">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">X-ray GÃ¶rÃ¼ntÃ¼sÃ¼</label>
                        <input type="file" name="file" accept="image/*" class="mt-1 block w-full" required id="xrayFile">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Tahmin Yap
                    </button>
                </form>
            </div>

            <!-- X-ray GÃ¶rÃ¼ntÃ¼ Ã–nizleme -->
            <div class="bg-white shadow rounded-lg p-6 mb-6" id="previewContainer" style="display: none;">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">X-ray GÃ¶rÃ¼ntÃ¼ Ã–nizleme</h3>
                <div class="relative max-w-lg mx-auto border-2 border-gray-200 rounded-lg overflow-hidden">
                    <img id="xrayPreview" class="w-full h-auto max-h-96 object-contain bg-gray-50" alt="X-ray Ã–nizleme">
                </div>
                <p class="text-sm text-gray-500 text-center mt-2" id="imageInfo"></p>
            </div>

            <!-- Tahmin Sonucu AÃ§Ä±klama AlanÄ± (Dinamik) -->
            {% if prediction_result %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-green-800 mb-2">Tahmin Sonucu</h3>
                <p class="text-green-700 mb-1">Tespit Edilen: <span class="font-bold">{{ prediction_result }}</span></p>
                
                <!-- Dinamik HastalÄ±k Bilgisi -->
                <div id="diseaseInfo" class="mt-3">
                    <div class="animate-pulse">
                        <div class="h-4 bg-green-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-green-200 rounded w-1/2"></div>
                    </div>
                </div>
                
                <!-- SaÄŸlÄ±k AsistanÄ± Rapor ButonlarÄ± -->
                <div class="mt-4 space-y-2">
                    <button onclick="generateComprehensiveReport('{{ prediction_result }}', 'X-ray GÃ¶rÃ¼ntÃ¼ Analizi')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-300">
                        ğŸ“‹ DetaylÄ± SaÄŸlÄ±k Raporu OluÅŸtur
                    </button>
                    <button onclick="showDiseaseInfo('{{ prediction_result }}')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-300">
                        â„¹ï¸ HastalÄ±k HakkÄ±nda Bilgi Al
                    </button>
                </div>
                
                <!-- Rapor Ã–nizleme AlanÄ± -->
                <div id="reportPreview" class="mt-4 p-4 bg-white rounded-lg border border-gray-200" style="display: none;">
                    <h4 class="font-semibold text-gray-800 mb-2">Rapor Ã–nizleme</h4>
                    <div id="reportContent" class="text-sm text-gray-700 max-h-40 overflow-y-auto"></div>
                    <div class="mt-3 flex space-x-2">
                        <button onclick="downloadReport()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-medium">
                            ğŸ“¥ PDF Ä°ndir
                        </button>
                        <button onclick="closeReportPreview()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs font-medium">
                            âœ• Kapat
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- YÃ¼kleme ve SonuÃ§ GeÃ§miÅŸi -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">YÃ¼kleme ve SonuÃ§ GeÃ§miÅŸi</h3>
                {% if prediction_history %}
                <table class="min-w-full text-left text-gray-700">
                    <thead>
                        <tr>
                            <th class="py-2 px-4">Tarih</th>
                            <th class="py-2 px-4">Dosya AdÄ±</th>
                            <th class="py-2 px-4">SonuÃ§</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prediction in prediction_history %}
                        <tr class="border-t">
                            <td class="py-2 px-4">{{ prediction.prediction_date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="py-2 px-4">{{ prediction.filename }}</td>
                            <td class="py-2 px-4">{{ prediction.prediction_result }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-gray-600">HenÃ¼z tahmin geÃ§miÅŸi bulunmamaktadÄ±r.</p>
                {% endif %}
            </div>

            <!-- Tahmin Ä°statistikleri -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tahmin Ä°statistikleri</h3>
                <div class="h-64">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>

            <!-- SÄ±kÃ§a Sorulan Sorular (SSS) -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">SÄ±kÃ§a Sorulan Sorular</h3>
                <div class="mb-2">
                    <p class="font-medium">X-ray gÃ¶rÃ¼ntÃ¼sÃ¼ nasÄ±l yÃ¼klemeliyim?</p>
                    <p class="text-gray-700 text-sm">Dijital X-ray gÃ¶rÃ¼ntÃ¼nÃ¼zÃ¼ JPG veya PNG formatÄ±nda yÃ¼kleyebilirsiniz. GÃ¶rÃ¼ntÃ¼ kalitesi yÃ¼ksek olmalÄ±dÄ±r.</p>
                </div>
                <div class="mb-2">
                    <p class="font-medium">Hangi hastalÄ±klar tespit edilebilir?</p>
                    <p class="text-gray-700 text-sm">SaÄŸlÄ±klÄ±, Konjenital Anomali, KOAH, Mediastinal Kitle, Plevral EfÃ¼zyon, AkciÄŸer Ä°ltihabÄ±, AkciÄŸer SÃ¶nmesi (Pneumotorax), TÃ¼berkÃ¼loz ve AkciÄŸer TÃ¼mÃ¶rÃ¼.</p>
                </div>
                <div class="mb-2">
                    <p class="font-medium">SonuÃ§lar ne kadar gÃ¼venilir?</p>
                    <p class="text-gray-700 text-sm">Yapay zeka modellerimiz yÃ¼ksek doÄŸruluk oranÄ±na sahiptir, ancak sonuÃ§lar kesin tÄ±bbi teÅŸhis yerine geÃ§mez.</p>
                </div>
                <div>
                    <p class="font-medium">YÃ¼klediÄŸim gÃ¶rÃ¼ntÃ¼ler gÃ¼vende mi?</p>
                    <p class="text-gray-700 text-sm">Evet, tÃ¼m gÃ¶rÃ¼ntÃ¼leriniz gizli tutulur ve sadece analiz iÃ§in kullanÄ±lÄ±r.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar toggle code - null kontrolleri ile gÃ¼venli hale getirildi
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            // Sidebar elementlerinin varlÄ±ÄŸÄ±nÄ± kontrol et ve sadece varsa iÅŸlem yap
            if (sidebar && mainContent && sidebarToggle) {
                try {
                    // Sidebar durumunu localStorage'dan al
                    const savedState = localStorage.getItem('sidebarState');
                    let isSidebarCollapsed = savedState === 'collapsed';

                    function updateSidebar() {
                        if (sidebar && mainContent && sidebarToggle) {
                            sidebar.classList.toggle('collapsed', isSidebarCollapsed);
                            mainContent.classList.toggle('expanded', isSidebarCollapsed);
                            sidebarToggle.classList.toggle('collapsed', isSidebarCollapsed);
                            localStorage.setItem('sidebarState', isSidebarCollapsed ? 'collapsed' : 'expanded');
                        }
                    }

                    sidebarToggle.addEventListener('click', () => {
                        isSidebarCollapsed = !isSidebarCollapsed;
                        updateSidebar();
                    });

                    updateSidebar();
                } catch (error) {
                    console.error('Sidebar iÅŸlevinde hata:', error);
                }
            } else {
                console.warn('Sidebar elementlerinden biri veya birkaÃ§Ä± bulunamadÄ± - bu normal olabilir');
            }

            // X-ray image preview handling - gÃ¼venli null kontrolleri ile
            const xrayFileInput = document.getElementById('xrayFile');
            const previewContainer = document.getElementById('previewContainer');
            const xrayPreview = document.getElementById('xrayPreview');
            const imageInfo = document.getElementById('imageInfo');

            // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et
            if (!xrayFileInput) {
                console.error('xrayFile input elementi bulunamadÄ±!');
                return;
            }
            if (!previewContainer) {
                console.error('previewContainer elementi bulunamadÄ±!');
                return;
            }
            if (!xrayPreview) {
                console.error('xrayPreview img elementi bulunamadÄ±!');
                return;
            }
            if (!imageInfo) {
                console.error('imageInfo elementi bulunamadÄ±!');
                return;
            }

            // Dosya input event listener'Ä±nÄ± gÃ¼venli ÅŸekilde ekle
            try {
                xrayFileInput.addEventListener('change', function(e) {
                    console.log('File input changed'); // Debug log
                    const file = e.target.files[0];
                    console.log('Selected file:', file); // Debug log
                    
                    if (file) {
                        // Dosya tÃ¼rÃ¼ kontrolÃ¼
                        if (!file.type.startsWith('image/')) {
                            alert('LÃ¼tfen geÃ§erli bir gÃ¶rÃ¼ntÃ¼ dosyasÄ± seÃ§in.');
                            return;
                        }
                        
                        console.log('File is valid image'); // Debug log
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log('FileReader loaded'); // Debug log
                                xrayPreview.src = e.target.result;
                                previewContainer.style.display = 'block';
                                
                                // Dosya bilgilerini gÃ¶ster
                                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                                imageInfo.textContent = `Dosya: ${file.name} | Boyut: ${fileSize} MB | Tip: ${file.type}`;
                                console.log('Preview updated'); // Debug log
                            } catch (error) {
                                console.error('GÃ¶rÃ¼ntÃ¼ Ã¶nizleme hatasÄ±:', error);
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        console.log('No file selected'); // Debug log
                        previewContainer.style.display = 'none';
                        imageInfo.textContent = '';
                    }
                });
            } catch (error) {
                console.error('File input event listener eklenirken hata:', error);
            }

            // Prediction statistics chart
            try {
                const predictionStats = {{ prediction_stats|tojson|safe }};
                console.log('Prediction Stats:', predictionStats);
                
                // Chart'Ä± oluÅŸtur
                const chartCanvas = document.getElementById('predictionChart');
                
                if (chartCanvas) {
                    // Veri kontrolÃ¼ - hem obje var mÄ± hem de iÃ§inde deÄŸer var mÄ±
                    const hasData = predictionStats && 
                                   typeof predictionStats === 'object' && 
                                   Object.keys(predictionStats).length > 0 && 
                                   Object.values(predictionStats).some(val => val > 0);
                    
                    if (hasData) {
                        // Sadece 0'dan bÃ¼yÃ¼k deÄŸerleri filtrele
                        const filteredStats = {};
                        Object.keys(predictionStats).forEach(key => {
                            if (predictionStats[key] > 0) {
                                filteredStats[key] = predictionStats[key];
                            }
                        });
                        
                        if (Object.keys(filteredStats).length > 0) {
                            const predictionChart = new Chart(chartCanvas, {
                                type: 'bar',
                                data: {
                                    labels: Object.keys(filteredStats),
                                    datasets: [{
                                        label: 'Tahmin SayÄ±sÄ±',
                                        data: Object.values(filteredStats),
                                        backgroundColor: [
                                            'rgba(54, 162, 235, 0.8)',
                                            'rgba(255, 99, 132, 0.8)',
                                            'rgba(75, 192, 192, 0.8)',
                                            'rgba(255, 206, 86, 0.8)',
                                            'rgba(153, 102, 255, 0.8)',
                                            'rgba(255, 159, 64, 0.8)',
                                            'rgba(201, 203, 207, 0.8)',
                                            'rgba(83, 102, 255, 0.8)',
                                            'rgba(255, 99, 255, 0.8)'
                                        ],
                                        borderColor: [
                                            'rgba(54, 162, 235, 1)',
                                            'rgba(255, 99, 132, 1)',
                                            'rgba(75, 192, 192, 1)',
                                            'rgba(255, 206, 86, 1)',
                                            'rgba(153, 102, 255, 1)',
                                            'rgba(255, 159, 64, 1)',
                                            'rgba(201, 203, 207, 1)',
                                            'rgba(83, 102, 255, 1)',
                                            'rgba(255, 99, 255, 1)'
                                        ],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                stepSize: 1
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        title: {
                                            display: true,
                                            text: 'X-ray Tahmin Ä°statistikleri'
                                        }
                                    }
                                }
                            });
                        } else {
                            // FiltrelenmiÅŸ veri yoksa
                            chartCanvas.style.display = 'none';
                            const chartContainer = chartCanvas.parentElement;
                            chartContainer.innerHTML = '<p class="text-gray-500 text-center">HenÃ¼z tahmin verisi bulunmamaktadÄ±r.</p>';
                        }
                    } else {
                        // EÄŸer veri yoksa boÅŸ chart mesajÄ± gÃ¶ster
                        chartCanvas.style.display = 'none';
                        const chartContainer = chartCanvas.parentElement;
                        chartContainer.innerHTML = '<p class="text-gray-500 text-center">HenÃ¼z tahmin verisi bulunmamaktadÄ±r.</p>';
                    }
                } else {
                    console.error('Chart canvas element bulunamadÄ±!');
                }
            } catch (error) {
                console.error('Chart oluÅŸturulurken hata:', error);
            }
        });
        
        // Global variables for report functionality
        let currentReportData = null;
        let currentReportFilename = null;
        
        // Function to generate comprehensive health report
        async function generateComprehensiveReport(diseaseName, predictionType) {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'â³ Rapor OluÅŸturuluyor...';
                button.disabled = true;
                
                const response = await fetch('/generate_comprehensive_health_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName,
                        prediction_type: predictionType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentReportData = data.pdf_data;
                    currentReportFilename = data.filename;
                    
                    // Show report preview
                    document.getElementById('reportContent').innerHTML = data.report_text.replace(/\n/g, '<br>');
                    document.getElementById('reportPreview').style.display = 'block';
                    
                    // Scroll to report preview
                    document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Rapor oluÅŸturulurken hata oluÅŸtu: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Rapor oluÅŸturulurken bir hata oluÅŸtu.');
            } finally {
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Function to show disease information
        async function showDiseaseInfo(diseaseName) {
            try {
                const diseaseInfoDiv = document.getElementById('diseaseInfo');
                diseaseInfoDiv.innerHTML = '<div class="animate-pulse"><div class="h-4 bg-green-200 rounded w-3/4 mb-2"></div><div class="h-4 bg-green-200 rounded w-1/2"></div></div>';
                
                const response = await fetch('/get_disease_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    diseaseInfoDiv.innerHTML = `<p class="text-green-700 text-sm">${data.disease_info}</p>`;
                } else {
                    diseaseInfoDiv.innerHTML = '<p class="text-red-600 text-sm">HastalÄ±k bilgisi alÄ±namadÄ±.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('diseaseInfo').innerHTML = '<p class="text-red-600 text-sm">HastalÄ±k bilgisi alÄ±namadÄ±.</p>';
            }
        }
        
        // Function to download report
        async function downloadReport() {
            if (!currentReportData) {
                alert('Ä°ndirilecek rapor bulunamadÄ±.');
                return;
            }
            
            try {
                // Ä°ndirme butonunu devre dÄ±ÅŸÄ± bÄ±rak
                const downloadBtn = event.target;
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'â³ Ä°ndiriliyor...';
                downloadBtn.disabled = true;
                
                const response = await fetch('/download_health_report_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pdf_data: currentReportData,
                        filename: currentReportFilename
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    
                    // Blob boyutunu kontrol et
                    if (blob.size === 0) {
                        throw new Error('PDF dosyasÄ± boÅŸ');
                    }
                    
                    // Dosya indirme iÅŸlemi
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = currentReportFilename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Temizlik
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);
                    
                    // BaÅŸarÄ± mesajÄ±
                    alert('PDF baÅŸarÄ±yla indirildi!');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'PDF indirme hatasÄ± oluÅŸtu.');
                }
            } catch (error) {
                console.error('PDF indirme hatasÄ±:', error);
                alert('PDF indirme hatasÄ±: ' + error.message);
            } finally {
                // Butonu eski haline getir
                const downloadBtn = event.target;
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        // Function to close report preview
        function closeReportPreview() {
            document.getElementById('reportPreview').style.display = 'none';
            currentReportData = null;
            currentReportFilename = null;
        }
        
        // Auto-load disease info when prediction result is available
        {% if prediction_result %}
        document.addEventListener('DOMContentLoaded', function() {
            showDiseaseInfo('{{ prediction_result }}');
        });
        {% endif %}

    </script>
{% endblock %} 