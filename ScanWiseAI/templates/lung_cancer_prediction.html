{% extends 'base.html' %}

{% block title %}ScanWiseAI - Akciƒüer Kanseri Tespiti{% endblock %}

{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>    </style>

    <div class="p-6">
            <!-- Kƒ±sa A√ßƒ±klama ve Bilgilendirme -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">X-ray ile Akciƒüer Kanseri Tespiti</h2>
                <p class="text-gray-700 mb-2">Bu mod√ºl, y√ºklediƒüiniz X-ray g√∂r√ºnt√ºs√ºn√º analiz ederek akciƒüer kanseri riskini deƒüerlendirir:</p>
                <ul class="list-disc list-inside text-gray-700 mb-2">
                    <li>Saƒülƒ±klƒ±</li>
                    <li>Benign (ƒ∞yi Huylu)</li>
                    <li>Malignant (K√∂t√º Huylu)</li>
                </ul>
                <p class="text-gray-600">Yapay zeka destekli analiz ile erken te≈ühis ve tedavi ≈üansƒ±nƒ±zƒ± artƒ±rƒ±n.</p>
            </div>

            <!-- √ñrnek Dosya veya Demo -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                <span class="text-blue-700 font-medium">Sistemi denemek i√ßin √∂rnek X-ray g√∂r√ºnt√ºlerini indirebilirsiniz.</span>
                <a href="/static/demo/ornek_onkolojik_xray.zip" download class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-300">√ñrnek Dosya ƒ∞ndir</a>
            </div>

            <!-- Tahmin Formu -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <form action="" method="post" enctype="multipart/form-data" class="space-y-4" id="predictionForm">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">X-ray G√∂r√ºnt√ºs√º</label>
                        <input type="file" name="file" accept="image/*" class="mt-1 block w-full" required id="xrayFile">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Tahmin Yap
                    </button>
                </form>
            </div>

            <!-- X-ray G√∂r√ºnt√º √ñnizleme -->
            <div class="bg-white shadow rounded-lg p-6 mb-6" id="previewContainer" style="display: none;">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">X-ray G√∂r√ºnt√º √ñnizleme</h3>
                <div class="relative aspect-[4/3] max-w-lg mx-auto">
                    <img id="xrayPreview" class="w-full h-full object-contain" alt="X-ray √ñnizleme">
                </div>
            </div>

            <!-- Tahmin Sonucu A√ßƒ±klama Alanƒ± (Dinamik) -->
            {% if prediction_result %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-green-800 mb-2">Tahmin Sonucu</h3>
                <p class="text-green-700 mb-1">Tespit Edilen: <span class="font-bold">{{ prediction_result }}</span></p>
                
                <!-- Dinamik Hastalƒ±k Bilgisi -->
                <div id="diseaseInfo" class="mt-3">
                    <div class="animate-pulse">
                        <div class="h-4 bg-green-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-green-200 rounded w-1/2"></div>
                    </div>
                </div>
                
                <!-- Saƒülƒ±k Asistanƒ± Rapor Butonlarƒ± -->
                <div class="mt-4 space-y-2">
                    <button onclick="generateComprehensiveReport('{{ prediction_result }}', 'Akciƒüer Kanseri Analizi')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-300">
                        üìã Detaylƒ± Saƒülƒ±k Raporu Olu≈ütur
                    </button>
                    <button onclick="showDiseaseInfo('{{ prediction_result }}')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-300">
                        ‚ÑπÔ∏è Hastalƒ±k Hakkƒ±nda Bilgi Al
                    </button>
                </div>
                
                <!-- Rapor √ñnizleme Alanƒ± -->
                <div id="reportPreview" class="mt-4 p-4 bg-white rounded-lg border border-gray-200" style="display: none;">
                    <h4 class="font-semibold text-gray-800 mb-2">Rapor √ñnizleme</h4>
                    <div id="reportContent" class="text-sm text-gray-700 max-h-40 overflow-y-auto"></div>
                    <div class="mt-3 flex space-x-2">
                        <button onclick="downloadReport()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-medium">
                            üì• PDF ƒ∞ndir
                        </button>
                        <button onclick="closeReportPreview()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs font-medium">
                            ‚úï Kapat
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Y√ºkleme ve Sonu√ß Ge√ßmi≈üi -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Y√ºkleme ve Sonu√ß Ge√ßmi≈üi</h3>
                {% if prediction_history %}
                <table class="min-w-full text-left text-gray-700">
                    <thead>
                        <tr>
                            <th class="py-2 px-4">Tarih</th>
                            <th class="py-2 px-4">Dosya Adƒ±</th>
                            <th class="py-2 px-4">Sonu√ß</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prediction in prediction_history %}
                        <tr class="border-t">
                            <td class="py-2 px-4">{{ prediction.prediction_date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="py-2 px-4">{{ prediction.filename }}</td>
                            <td class="py-2 px-4">{{ prediction.prediction_result }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-gray-600">Hen√ºz tahmin ge√ßmi≈üi bulunmamaktadƒ±r.</p>
                {% endif %}
            </div>

            <!-- Tahmin ƒ∞statistikleri -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tahmin ƒ∞statistikleri</h3>
                <div class="h-64">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>

            <!-- Sƒ±k√ßa Sorulan Sorular (SSS) -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Sƒ±k√ßa Sorulan Sorular</h3>
                <div class="mb-2">
                    <p class="font-medium">X-ray g√∂r√ºnt√ºs√º nasƒ±l y√ºklemeliyim?</p>
                    <p class="text-gray-700 text-sm">Dijital X-ray g√∂r√ºnt√ºn√ºz√º JPG veya PNG formatƒ±nda y√ºkleyebilirsiniz. G√∂r√ºnt√º kalitesi y√ºksek olmalƒ±dƒ±r.</p>
                </div>
                <div class="mb-2">
                    <p class="font-medium">Hangi sonu√ßlar tespit edilebilir?</p>
                    <p class="text-gray-700 text-sm">Saƒülƒ±klƒ±, Benign (ƒ∞yi Huylu) ve Malignant (K√∂t√º Huylu) olmak √ºzere √º√ß farklƒ± sonu√ß tespit edilebilir.</p>
                </div>
                <div class="mb-2">
                    <p class="font-medium">Sonu√ßlar ne kadar g√ºvenilir?</p>
                    <p class="text-gray-700 text-sm">Yapay zeka modellerimiz y√ºksek doƒüruluk oranƒ±na sahiptir, ancak sonu√ßlar kesin tƒ±bbi te≈ühis yerine ge√ßmez.</p>
                </div>
                <div>
                    <p class="font-medium">Y√ºklediƒüim g√∂r√ºnt√ºler g√ºvende mi?</p>
                    <p class="text-gray-700 text-sm">Evet, t√ºm g√∂r√ºnt√ºleriniz gizli tutulur ve sadece analiz i√ßin kullanƒ±lƒ±r.</p>
                </div>
            </div>
        </div>
    </div>    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar toggle code - null kontrolleri ile g√ºvenli hale getirildi
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            // Sidebar elementlerinin varlƒ±ƒüƒ±nƒ± kontrol et
            if (sidebar && mainContent && sidebarToggle) {
                try {
                    // Sidebar durumunu localStorage'dan al
                    const savedState = localStorage.getItem('sidebarState');
                    let isSidebarCollapsed = savedState === 'collapsed';

                    function updateSidebar() {
                        sidebar.classList.toggle('collapsed', isSidebarCollapsed);
                        mainContent.classList.toggle('expanded', isSidebarCollapsed);
                        sidebarToggle.classList.toggle('collapsed', isSidebarCollapsed);
                        localStorage.setItem('sidebarState', isSidebarCollapsed ? 'collapsed' : 'expanded');
                    }

                    sidebarToggle.addEventListener('click', () => {
                        isSidebarCollapsed = !isSidebarCollapsed;
                        updateSidebar();
                    });

                    updateSidebar();
                } catch (error) {
                    console.error('Sidebar i≈ülevinde hata:', error);
                }
            } else {
                console.warn('Sidebar elementlerinden biri veya birka√ßƒ± bulunamadƒ±');
            }            // X-ray image preview handling - g√ºvenli null kontrolleri ile
            const xrayFileInput = document.getElementById('xrayFile');
            const previewContainer = document.getElementById('previewContainer');
            const xrayPreview = document.getElementById('xrayPreview');

            // Elementlerin varlƒ±ƒüƒ±nƒ± kontrol et
            if (xrayFileInput && previewContainer && xrayPreview) {
                try {
                    xrayFileInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Dosya t√ºr√º kontrol√º
                            if (!file.type.startsWith('image/')) {
                                alert('L√ºtfen ge√ßerli bir g√∂r√ºnt√º dosyasƒ± se√ßin.');
                                return;
                            }
                            
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                xrayPreview.src = e.target.result;
                                previewContainer.style.display = 'block';
                            };
                            reader.readAsDataURL(file);
                        } else {
                            previewContainer.style.display = 'none';
                        }
                    });
                } catch (error) {
                    console.error('Image preview i≈ülevinde hata:', error);
                }
            } else {
                console.error('X-ray preview elementlerinden biri veya birka√ßƒ± bulunamadƒ±');
            }            // Prediction statistics chart - g√ºvenli hale getirildi
            try {
                const predictionStats = {{ prediction_stats|tojson|safe }};
                const chartCanvas = document.getElementById('predictionChart');
                
                if (chartCanvas && predictionStats) {
                    // Veri kontrol√º
                    const hasData = typeof predictionStats === 'object' && 
                                   Object.keys(predictionStats).length > 0 && 
                                   Object.values(predictionStats).some(val => val > 0);
                    
                    if (hasData) {
                        const predictionChart = new Chart(chartCanvas, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(predictionStats),
                                datasets: [{
                                    label: 'Tahmin Sayƒ±sƒ±',
                                    data: Object.values(predictionStats),
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.8)',
                                        'rgba(75, 192, 192, 0.8)',
                                        'rgba(255, 99, 132, 0.8)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(255, 99, 132, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Akciƒüer Kanseri Tahmin ƒ∞statistikleri'
                                    }
                                }
                            }
                        });
                    } else {
                        // Veri yoksa bo≈ü chart mesajƒ± g√∂ster
                        chartCanvas.style.display = 'none';
                        const chartContainer = chartCanvas.parentElement;
                        chartContainer.innerHTML = '<p class="text-gray-500 text-center">Hen√ºz tahmin verisi bulunmamaktadƒ±r.</p>';
                    }
                } else {
                    console.error('Chart canvas element veya prediction data bulunamadƒ±');
                }
            } catch (error) {
                console.error('Chart olu≈üturulurken hata:', error);
            }
        });
        
        // Global variables for report functionality
        let currentReportData = null;
        let currentReportFilename = null;
        
        // Function to generate comprehensive health report
        async function generateComprehensiveReport(diseaseName, predictionType) {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚è≥ Rapor Olu≈üturuluyor...';
                button.disabled = true;
                
                const response = await fetch('/generate_comprehensive_health_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName,
                        prediction_type: predictionType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentReportData = data.pdf_data;
                    currentReportFilename = data.filename;
                    
                    // Show report preview
                    document.getElementById('reportContent').innerHTML = data.report_text.replace(/\n/g, '<br>');
                    document.getElementById('reportPreview').style.display = 'block';
                    
                    // Scroll to report preview
                    document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Rapor olu≈üturulurken hata olu≈ütu: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Rapor olu≈üturulurken bir hata olu≈ütu.');
            } finally {
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Function to show disease information
        async function showDiseaseInfo(diseaseName) {
            try {
                const diseaseInfoDiv = document.getElementById('diseaseInfo');
                diseaseInfoDiv.innerHTML = '<div class="animate-pulse"><div class="h-4 bg-green-200 rounded w-3/4 mb-2"></div><div class="h-4 bg-green-200 rounded w-1/2"></div></div>';
                
                const response = await fetch('/get_disease_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    diseaseInfoDiv.innerHTML = `<p class="text-green-700 text-sm">${data.disease_info}</p>`;
                } else {
                    diseaseInfoDiv.innerHTML = '<p class="text-red-600 text-sm">Hastalƒ±k bilgisi alƒ±namadƒ±.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('diseaseInfo').innerHTML = '<p class="text-red-600 text-sm">Hastalƒ±k bilgisi alƒ±namadƒ±.</p>';
            }
        }
        
        // Function to download report
        async function downloadReport() {
            if (!currentReportData) {
                alert('ƒ∞ndirilecek rapor bulunamadƒ±.');
                return;
            }
            
            try {
                // ƒ∞ndirme butonunu devre dƒ±≈üƒ± bƒ±rak
                const downloadBtn = event.target;
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = '‚è≥ ƒ∞ndiriliyor...';
                downloadBtn.disabled = true;
                
                const response = await fetch('/download_health_report_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pdf_data: currentReportData,
                        filename: currentReportFilename
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    
                    // Blob boyutunu kontrol et
                    if (blob.size === 0) {
                        throw new Error('PDF dosyasƒ± bo≈ü');
                    }
                    
                    // Dosya indirme i≈ülemi
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = currentReportFilename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Temizlik
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);
                    
                    // Ba≈üarƒ± mesajƒ±
                    alert('PDF ba≈üarƒ±yla indirildi!');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'PDF indirme hatasƒ± olu≈ütu.');
                }
            } catch (error) {
                console.error('PDF indirme hatasƒ±:', error);
                alert('PDF indirme hatasƒ±: ' + error.message);
            } finally {
                // Butonu eski haline getir
                const downloadBtn = event.target;
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        // Function to close report preview
        function closeReportPreview() {
            document.getElementById('reportPreview').style.display = 'none';
            currentReportData = null;
            currentReportFilename = null;
        }
        
        // Auto-load disease info when prediction result is available
        {% if prediction_result %}
        document.addEventListener('DOMContentLoaded', function() {
            showDiseaseInfo('{{ prediction_result }}');
        });
        {% endif %}

    </script>
{% endblock %}